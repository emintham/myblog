---
// src/pages/admin/manage-posts.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../../config/index";
import "../../styles/admin.css";

if (!import.meta.env.DEV) {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

const posts = await getCollection("blog");
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const pageTitle = `Manage Posts - ${SITE_TITLE}`;
const pageDescription =
  "Create or edit blog posts. This page is available in development mode only.";
---

<BaseLayout title={pageTitle} description={pageDescription} isAdminPage={true}>
  <div class="admin-actions">
    <a href="/admin/create-post" class="button-primary" role="button"
      >Create New Post</a
    >
  </div>

  {
    posts.length === 0 ? (
      <p class="empty-state-message">
        No posts found. Ready to create your first one?
      </p>
    ) : (
      <>
        <div class="filter-controls">
          <label for="status-filter">Filter by status:</label>
          <select id="status-filter" class="status-filter-select">
            <option value="all">All Posts</option>
            <option value="published">Published Only</option>
            <option value="drafts">Drafts Only</option>
          </select>
          <span id="post-count" class="post-count"></span>
        </div>

        <ul class="item-list-container admin-post-list" id="posts-list">
          {posts.map((post) => (
            <li class="list-item-entry" data-draft={post.data.draft ? "true" : "false"}>
              <div class="post-info-column">
                <div class="title-line">
                  {post.data.draft && (
                    <span class="status-draft-badge">Draft</span>
                  )}
                  <a
                    href={`/blog/${post.slug}/`}
                    class:list={[
                      "list-item-name",
                      { "title-with-draft-badge": post.data.draft },
                    ]}
                    target="_blank"
                    rel="noopener noreferrer"
                    title={`View '${post.data.title}' live`}
                  >
                    {post.data.title}
                  </a>
                </div>
                <small class="post-meta-details">
                  {post.data.pubDate.toLocaleDateString("en-CA", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}{" "}
                  |
                  <span class="post-type-label">
                    {post.data.postType || "standard"}
                  </span>
                </small>
              </div>
              <a
                href={`/admin/edit/${post.slug}/`}
                class="button-edit"
                role="button"
              >
                Edit
              </a>
              <a
                href="#"
                role="button"
                class="button-delete"
                data-slug={post.slug}
                data-post-title={post.data.title}
                data-quotes-ref={post.data.postType === 'bookNote' && post.data.quotesRef ? post.data.quotesRef : ''}
              >
                Delete
              </a>
            </li>
          ))}
        </ul>
      </>
    )
  }

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusFilter = document.getElementById('status-filter');
    const postsList = document.getElementById('posts-list');
    const postCount = document.getElementById('post-count');
    const deleteButtons = document.querySelectorAll('.button-delete');

    // Filter functionality
    function updatePostsDisplay() {
      if (!statusFilter || !postsList) return;

      const filterValue = statusFilter.value;
      const allPosts = postsList.querySelectorAll('.list-item-entry');
      let visibleCount = 0;

      allPosts.forEach(post => {
        const isDraft = post.dataset.draft === 'true';
        let shouldShow = false;

        switch (filterValue) {
          case 'all':
            shouldShow = true;
            break;
          case 'published':
            shouldShow = !isDraft;
            break;
          case 'drafts':
            shouldShow = isDraft;
            break;
        }

        if (shouldShow) {
          post.style.display = '';
          visibleCount++;
        } else {
          post.style.display = 'none';
        }
      });

      // Update count display
      if (postCount) {
        const totalCount = allPosts.length;
        postCount.textContent = `Showing ${visibleCount} of ${totalCount} posts`;
      }
    }

    // Listen for filter changes
    if (statusFilter) {
      statusFilter.addEventListener('change', updatePostsDisplay);
      // Initial display update
      updatePostsDisplay();
    }

    // Delete functionality
    deleteButtons.forEach(button => {
      button.addEventListener('click', async (event) => {
        event.preventDefault();

        const slug = button.dataset.slug;
        const postTitle = button.dataset.postTitle || 'this post';

        if (!slug) {
          alert('Error: Could not find post slug for deletion.');
          return;
        }

        const confirmation = window.confirm(
          `Are you sure you want to delete the post titled "${postTitle}"? This action cannot be undone.`
        );

        if (confirmation) {
          try {
            const response = await fetch('/api/delete-post-handler', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ slug: slug }),
            });

            const result = await response.json();

            if (response.ok) {
              alert(result.message || 'Post deleted successfully!');
              const listItem = button.closest('li.list-item-entry');
              if (listItem) {
                listItem.remove();
                // Update count after deletion
                updatePostsDisplay();
              } else {
                window.location.reload();
              }
            } else {
              alert(`Error deleting post: ${result.message || 'Unknown error'}`);
            }
          } catch (error) {
            console.error('Failed to delete post:', error);
            alert('An error occurred while trying to delete the post. See console for details.');
          }
        }
      });
    });
  });
</script>
</BaseLayout>
