---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostForm from "../../components/admin/form/PostForm"; // Removed .tsx extension
import { SITE_TITLE } from "../../config/index";
import {
  getUniqueTagNames,
  getUniqueSeriesNames,
} from "../../utils/contentUtils"; // Updated path
import FeedbackDisplay from "../../components/admin/feedback/FeedbackDisplay";
import ToastContainer from "../../components/admin/feedback/ToastContainer";
import { AIAssistantPanel } from "../../components/admin/ai-assistant/AIAssistantPanel";
import { ErrorBoundary } from "../../components/admin/shared/ErrorBoundary";
import "../../styles/admin.css"; // Import admin styles
import "../../styles/ai-assistant.css"; // Import AI assistant styles

if (import.meta.env.PROD) {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

// Fetch all unique tag names for suggestions
const allPostTags = await getUniqueTagNames("blog", (data) => data.tags);
const allBookTags = await getUniqueTagNames(
  "blog",
  (data) => data.bookTags,
  (entry) => entry.data.postType === "bookNote"
);
const allQuoteTags = await getUniqueTagNames(
  "bookQuotes",
  (data) => data.quotes?.flatMap((q) => q.tags || []) || []
);
const allSeriesNames = await getUniqueSeriesNames();

const pageTitle = `Create New Post - ${SITE_TITLE}`;
const pageDescription = `Admin page to create a new post on ${SITE_TITLE}`;
const isEditMode = false; // or true, based on your logic
const postToEdit = null; // or the post data you want to edit
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="admin-content-wrapper">
    <header class="page-detail-header">
      <h1>{isEditMode ? "Edit Post" : "Create New Post"}</h1>
    </header>

    <form id="postAdminForm" class="post-form">
      <ErrorBoundary componentName="Post Form" client:load>
        <PostForm
          client:load
          postData={postToEdit}
          formId="postAdminForm"
          allPostTags={allPostTags}
          allBookTags={allBookTags}
          allQuoteTags={allQuoteTags}
          allSeriesNames={allSeriesNames}
        />
      </ErrorBoundary>
      <div class="admin-actions">
        <button type="submit" class="button-primary">
          {isEditMode ? "Update Post" : "Create Post"}
        </button>
      </div>
    </form>
    <FeedbackDisplay client:load formId="postAdminForm" />
    <ToastContainer client:only="react" formId="postAdminForm" />
    <ErrorBoundary componentName="AI Assistant" client:load>
      <AIAssistantPanel client:load sessionId="new-post" />
    </ErrorBoundary>
  </div>
</BaseLayout>
