---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { generateSlug } from "../../utils/slugify";
import Remark42Comments from "../../components/Remark42Comments.astro";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog", ({ data }) => {
    // Filter out drafts for path generation in production
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await entry.render();
const frontmatter = entry.data;
// remarkPluginFrontmatter contains data from the Markdown frontmatter after rendering

// Variables for the series link
const seriesName = frontmatter.series;
let seriesLinkPath = null;
if (seriesName && typeof seriesName === "string") {
  const seriesSlug = generateSlug(seriesName);
  seriesLinkPath = `/series/${seriesSlug}/`;
}

const postTags =
  frontmatter.tags &&
  Array.isArray(frontmatter.tags) &&
  frontmatter.tags.length > 0
    ? frontmatter.tags
        .map((tag) => {
          const tagName = tag.trim(); // Trim whitespace from tag name
          return {
            name: tagName, // Original name for display
            href: `/tags/${generateSlug(tagName)}/`, // Link to the tag page
          };
        })
        .filter((tag) => tag.name) // Ensure no empty tags after trimming
    : [];
const postUrlForComments = new URL(
  Astro.url.pathname,
  Astro.site || "http://localhost:4321"
).href;
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <article class="blog-post">
    <header class="post-header">
      <h1>{frontmatter.title}</h1>
      <p class="meta">
        Published on <time datetime={frontmatter.pubDate.toISOString()}>
          {
            new Date(frontmatter.pubDate).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </time>
        by {frontmatter.author}
        {
          seriesName && seriesLinkPath && (
            <span class="series-meta-inline">
              &bull; In series:{" "}
              <a
                href={seriesLinkPath}
                aria-label={`Read all posts in the series: ${seriesName}`}
              >
                {seriesName}
              </a>
            </span>
          )
        }
      </p>
    </header>
    <div class="post-content">
      <Content />
    </div>

    {/* Consolidated Tags and Series Footer */}
    {
      (postTags.length > 0 || (seriesLinkPath && seriesName)) && (
        <footer class="post-meta-footer">
          {seriesLinkPath && seriesName && (
            <div class="meta-item series-meta-item">
              <p class="series-statement">
                {" "}
                {/* Changed to p for semantic block content */}
                This post is part of{" "}
                <a
                  href={seriesLinkPath}
                  aria-label={`View all posts in the "${seriesName}" series`}
                >
                  {seriesName}
                </a>
                .
              </p>
            </div>
          )}

          {postTags.length > 0 && (
            <div class="meta-item tags-meta-item">
              <span class="meta-label">TAGS</span>
              <ul class="tags-list-style">
                {postTags.map((tag) => (
                  <li>
                    <a href={tag.href}>#{tag.name}</a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </footer>
      )
    }

    <Remark42Comments
      pageUrl={postUrlForComments}
      pageTitle={frontmatter.title}
      theme="light"
      {/* Or "dark", or pass dynamically based on site theme */}
    />
  </article>
</BaseLayout>

<style>
  .blog-post {
    /* Styles for single post layout */
  }
  .post-header {
    text-align: center;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    /* Consider removing or softening this border if you want an even cleaner look */
    /* border-bottom: 1px solid #eee; */ /* Very subtle - Original */
    /* Option: Softer border or remove completely */
    border-bottom: 1px solid var(--color-border-subtle); /* Keeping this for header separation, but could be removed */
  }
  .post-header h1 {
    font-size: 2.8rem; /* Larger for post title */
    margin-bottom: 0.5rem;
    line-height: 1.2;
    font-family: var(
      --font-display-title
    ); /* Using Spectral for post titles for a more editorial feel */
    font-weight: 700; /* Or 400 for a lighter feel */
  }
  .post-header .meta {
    font-family: var(--font-sans);
    font-size: 0.9rem;
    color: var(--color-meta);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .post-content {
    /* Typography here will be largely inherited from global.css */
  }

  /* Deeper styling for elements within .post-content if needed */
  .post-content h2 {
    margin-top: 2.5em;
    margin-bottom: 1em;
    font-family: var(--font-display-title); /* Consistent heading font */
    font-weight: 700; /* Or 400 */
  }
  .post-content img {
    max-width: 100%;
    height: auto;
    margin: 2.5em 0; /* Increased margin */
    border-radius: 0px; /* Kinfolk often uses sharp edges for images, or very subtle rounding */
    display: block;
  }
  .post-content blockquote {
    /* This will be overridden by the :global(blockquote) style below if you prefer that one.
       If you want a simpler blockquote without the large quote marks for some contexts,
       you might use a different class or adjust the :global one. */
    border-left: 2px solid var(--color-accent); /* Thinner, more subtle border */
    padding-left: 1.5em;
    margin: 2em 0; /* Adjusted margin */
    font-style: italic;
    color: var(--color-text); /* Slightly darker for better readability */
  }

  .post-meta-footer {
    margin-top: 4rem; /* Increased space above the entire meta footer */
    padding-top: 2rem; /* Increased space - was 1.5rem */
    /* border-top: 1px solid var(--color-border-subtle); */ /* REMOVED BORDER for a cleaner look */
    font-family: var(--font-sans);
    font-size: 0.9rem;
  }

  .meta-item {
    margin-bottom: 1rem; /* Increased space between "Series" and "Tags" block */
  }
  .meta-item:last-child {
    margin-bottom: 0;
  }

  .meta-label {
    display: block;
    font-weight: 600; /* Kept for clarity */
    color: var(--color-meta);
    margin-bottom: 0.8em; /* Slightly more space below label */
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.075em;
  }

  .tags-list-style {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em 1em; /* Slightly increased gap for better breathing room */
  }

  .tags-list-style a {
    color: var(--color-accent);
    text-decoration: none;
    font-size: 0.9rem;
    padding: 0.25em 0; /* Add a little vertical padding for touch targets / visual */
  }

  .tags-list-style a:hover {
    text-decoration: underline;
    color: var(--color-text);
  }

  .series-statement {
    margin: 0;
    color: var(--color-text);
    line-height: 1.7; /* Increased line-height for readability */
    font-size: 0.95rem; /* Slightly larger for emphasis */
    text-align: center; /* Kinfolk often uses left-align for text blocks */
    /* Consider centering if it's a short statement and fits the overall page design */
    /* max-width: 65ch; */ /* Optional: constrain line length for readability */
  }

  .series-statement a {
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 600;
  }

  .series-statement a:hover {
    text-decoration: underline;
    color: var(--color-text);
  }

  /* Kinfolk-inspired Blockquote with large decorative quotes */
  .post-content :global(blockquote) {
    font-family: var(--font-serif);
    font-style: italic;
    color: var(--color-text); /* Darker for better readability */
    border: none;
    padding: 1em 0em; /* Reduced side padding, rely on text-align and max-width */
    margin: 3em auto; /* Increased vertical margin, auto for horizontal centering */
    max-width: 50ch; /* Constrain width for readability and aesthetic */
    position: relative;
    text-align: center; /* Center the text of the blockquote */
    line-height: 1.7;
  }

  .post-content :global(blockquote::before),
  .post-content :global(blockquote::after) {
    font-family: var(--font-serif); /* Or a specific display serif */
    font-size: 4.5em; /* Slightly larger quote marks */
    color: var(--color-border-subtle); /* Very light grey for quote marks */
    position: absolute;
    line-height: 0;
  }

  .post-content :global(blockquote::before) {
    content: "“";
    top: 0.25em; /* Adjust for visual centering with new font size */
    left: -0.25em; /* Adjust to bring it slightly outside the text flow */
  }

  .post-content :global(blockquote::after) {
    content: "”";
    bottom: 0.15em; /* Adjust for visual centering */
    right: -0.25em; /* Adjust to bring it slightly outside the text flow */
  }

  .post-content :global(blockquote p) {
    margin-bottom: 0.75em;
    font-size: 1.05rem; /* Slightly larger text within blockquotes */
  }
  .post-content :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  /* Inline series link in post header meta */
  .series-meta-inline {
    font-family: var(--font-sans); /* Ensure consistency */
  }
  .series-meta-inline a {
    color: var(--color-accent);
    text-decoration: none;
  }
  .series-meta-inline a:hover {
    text-decoration: underline;
    color: var(--color-text);
  }
</style>
